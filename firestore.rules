rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * WEDDING SITE SECURITY RULES - PROTOTYPING MODE
     *
     * Core Philosophy:
     * This ruleset implements a wedding management system with two primary access tiers:
     * 1. Public/Guest Access: Allows viewing of the gift registry and event details, and the ability to submit RSVPs.
     * 2. Administrative Access: Managed via a dedicated 'roles_admin' collection. Admins have full control
     *    over the gift registry and event configurations, and can manage guest RSVPs.
     */

    // --- Global Helper Functions ---

    /**
     * @description Checks if the request is from an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user has administrative privileges.
     * Durante o prototipagem, incluímos permissões explícitas para o UID reportado
     * e o e-mail administrativo padrão.
     */
    function isAdmin() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) ||
        request.auth.uid == "X8JMY0mx3gdmjFLZ8mnkWBK5bvH2" ||
        request.auth.token.email == "admin@casamento.com" ||
        request.auth.token.email == "jviitor2628@gmail.com"
      );
    }

    /**
     * @description Verifies ownership of a document in the roles_admin collection.
     */
    function isSelfAdmin(adminId) {
      return isSignedIn() && request.auth.uid == adminId;
    }

    // --- Collection Rules ---

    /**
     * @description Manages the wedding gift registry. Publicly readable by guests, manageable by admins.
     */
    match /gifts/{giftId} {
      allow get, list: if true;
      allow create: if isAdmin() && request.resource.data.id == giftId;
      allow update: if isAdmin() && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Captures guest attendance. Guests can submit RSVPs; only admins can view or manage them.
     */
    match /rsvps/{rsvpId} {
      allow create: if request.resource.data.id == rsvpId;
      allow get, list, delete: if isAdmin();
      allow update: if isAdmin();
    }

    /**
     * @description Stores global event settings (singleton). Publicly readable; Admin editable.
     */
    match /event_settings/main_settings {
      allow get, list: if true;
      allow update: if isAdmin() && resource != null;
      allow create: if isAdmin();
      allow delete: if false;
    }

    /**
     * @description Manual dos Padrinhos settings. Publicly readable; Admin editable.
     */
    match /manual_settings/{settingId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Images for the Manual dos Padrinhos. Publicly readable; Admin manageable.
     */
    match /manual_images/{imageId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Database Access Control (DBAC) collection for admin identification.
     */
    match /roles_admin/{adminId} {
      allow get: if isSelfAdmin(adminId) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

  }
}